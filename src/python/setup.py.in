import os
import sys
import numpy as np
from setuptools import setup, Extension
from sysconfig import get_paths
import platform

pyinc = get_paths()['include'] 
npinc = np.get_include()

# Debug flag
debug_flag = @PYTOAST_DEBUG_FLAG@

# We pull the libraries from the release distribution install output. On Windows
# it would be fine to get these from the build tree, but on other OS we want the
# versions with the install RPATH in order that the libraries can be found. The
# rpath of the toast extension itself has to be set accordingly.
if sys.platform == 'win32':
    lib_ext = '.dll'
    lib_names = ['libmath','libfe','libstoast']
    link_dir = ['toast/lib']
    link_args = ''
    compile_args = ''
    pkg_files = {'toast': ['*.dll']}
elif sys.platform == 'linux':
    lib_ext = '.so'
    lib_names = ['math','fe','stoast']
    link_dir = ['toast/lib']
    link_args = ['-Wl,-rpath=$ORIGIN/lib']
    compile_args = ['-std=c++98','-Wno-comment']
    pkg_files = {'toast': ['lib/*.so']}
elif sys.platform == 'darwin':
    lib_ext = '.dylib'
    lib_names = ['math','fe','stoast']
    link_dir = ['toast/lib']
    link_args = ['-Wl,-rpath=@loader_path/lib']
    pkg_files = {'toast': ['lib/*.dylib']}
else:
    raise Exception('Unknown platform')

if debug_flag:
    compile_args.extend(['-O0','-g'])

# Define the toast C extension
#
module1 = Extension('toast.toastmod',
                    include_dirs = [pyinc,
                                    npinc,
                                    @PYTOAST_INCLUDE_STRING@],
                    library_dirs = link_dir,
                    libraries = lib_names,
                    extra_link_args = link_args,
                    extra_compile_args = compile_args,
                    define_macros = [('NPY_NO_DEPRECATED_API', 'NPY_1_7_API_VERSION'),
                                     ('Py_LIMITED_API', '0x030500F0')],
                    py_limited_api=True,
                    sources = ['toastmodule.cc'])

                         
# Define installation
setup(
    name = 'PyToast',
    version = '0.1.0',
    description = 'Python TOAST extension',
    author = 'The Toast Authors',
    url = 'http://www.toastplusplus.org',
    setup_requires=['wheel'],
    install_requires=["numpy", "scipy"],
    python_requires='>=3',
    extras_require={  
        "demo": ["matplotlib"]
    },
    ext_modules = [module1],
    packages=['toast'],
    package_data = pkg_files,
    include_package_data=True
)
